<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Changing and restoring state • withr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Changing and restoring state">
<meta property="og:description" content="withr">
<meta property="og:image" content="https://withr.r-lib.org/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">withr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.4.3.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Release notes</li>
    <li>
      <a href="https://www.tidyverse.org/blog/2017/11/withr-2.1.0/" class="external-link">Version 2.1.0</a>
    </li>
    <li class="divider">
    </li>
<li>
      <a href="../news/index.html">Change log</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/withr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="changing-and-restoring-state_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Changing and restoring state</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/withr/blob/HEAD/vignettes/changing-and-restoring-state.Rmd" class="external-link"><code>vignettes/changing-and-restoring-state.Rmd</code></a></small>
      <div class="hidden name"><code>changing-and-restoring-state.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://withr.r-lib.org">withr</a></span><span class="op">)</span></code></pre></div>
<!-- This vignette uses a git-diff-friendly convention of ONE LINE PER SENTENCE. -->
<p>This article explains the type of problem withr solves and shows typical patterns of usage. It also compares withr’s functionality to the <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> function from base R.</p>
<div class="section level2">
<h2 id="its-dangerous-to-change-state">It’s dangerous to change state<a class="anchor" aria-label="anchor" href="#its-dangerous-to-change-state"></a>
</h2>
<p>Whenever possible, it is desirable to write so-called <strong>pure</strong> functions. The property we focus on here is that the function should not change the surrounding R landscape, i.e. it should not change things like the search path, global options, or the working directory. If the behaviour of <em>other</em> functions differs before and after running your function, you’ve modified the landscape. Changing the landscape is bad because it makes code much harder to understand.</p>
<p>Here’s a <code>sloppy()</code> function that prints a number with a specific number of significant digits, by adjusting R’s global “digits” option.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sloppy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span>

<span class="fu">sloppy</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.1</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.1</span></code></pre></div>
<p>Notice how <code>pi</code> prints differently before and after the call to <code>sloppy()</code>? Calling <code>sloppy()</code> has a side effect: it changes the “digits” option globally, not just within its own scope of operations. This is what we want to avoid.</p>
<p><em>Don’t worry, we’re restoring global state (specifically, the “digits” option) behind the scenes here.</em></p>
<p>Sometimes you cannot avoid modifying the state of the world, in which case you just have to make sure that you put things back the way you found them. This is what the withr package is for.</p>
</div>
<div class="section level2">
<h2 id="the-base-solution-on-exit">The base solution: <code>on.exit()</code><a class="anchor" aria-label="anchor" href="#the-base-solution-on-exit"></a>
</h2>
<p>The first function to know about is base R’s <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>. Inside your function body, every time you do something that should be undone <strong>on exit</strong>, you immediately register the cleanup code with <code>on.exit(expr, add = TRUE)</code><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>.</p>
<p><code>neat()</code> is an improvement over <code>sloppy()</code>, because it uses <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> to ensure that the “digits” option is restored to its original value.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span>

<span class="fu">neat</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.1</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span></code></pre></div>
<p><code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> also works when you exit the function abnormally, i.e. due to error. This is why official tools, like <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>, are a better choice than any do-it-yourself solution to this problem.</p>
<p><code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> is a very useful function, but it’s not very flexible. The withr package provides an extensible <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>-inspired toolkit.</p>
</div>
<div class="section level2">
<h2 id="defer-is-the-foundation-of-withr">
<code>defer()</code> is the foundation of withr<a class="anchor" aria-label="anchor" href="#defer-is-the-foundation-of-withr"></a>
</h2>
<p><code><a href="../reference/defer.html">defer()</a></code> is the core function of withr and is very much like <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>, i.e. it schedules the execution of arbitrary code when the current function exits:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neater</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span>
  <span class="fu"><a href="../reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span>

<span class="fu">neater</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.1</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span></code></pre></div>
<p><code><a href="../reference/defer.html">withr::defer()</a></code> is basically a drop-in substitute for <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>, but with three key differences we explore below:</p>
<ol style="list-style-type: decimal">
<li>Different default behaviour around the effect of a series of two or more calls</li>
<li>Control over the environment the deferred events are associated with</li>
<li>Ability to work with the global environment</li>
</ol>
<p>Here we focus on using withr inside your functions. See the blog post <a href="https://www.tidyverse.org/blog/2020/04/self-cleaning-test-fixtures/" class="external-link">Self-cleaning test fixtures</a> or the testthat vignette <a href="https://testthat.r-lib.org/articles/test-fixtures.html" class="external-link">Test fixtures</a> for how to use withr inside tests.</p>
</div>
<div class="section level2">
<h2 id="last-in-first-out">Last-in, first-out<a class="anchor" aria-label="anchor" href="#last-in-first-out"></a>
</h2>
<p>If you make more than one call to <code><a href="../reference/defer.html">defer()</a></code>, by default, it <strong>adds</strong> expressions to the <strong>top</strong> of the stack of deferred actions.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">defer_stack</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"put on socks\n"</span><span class="op">)</span>
  <span class="fu"><a href="../reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"take off socks\n"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"put on shoes\n"</span><span class="op">)</span>
  <span class="fu"><a href="../reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"take off shoes\n"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">defer_stack</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; put on socks</span>
<span class="co">#&gt; put on shoes</span>
<span class="co">#&gt; take off shoes</span>
<span class="co">#&gt; take off socks</span></code></pre></div>
<p>In contrast, by default, a subsequent call to <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> <strong>overwrites</strong> the deferred actions registered in the previous call.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">on_exit_last_one_wins</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"put on socks\n"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"take off socks\n"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"put on shoes\n"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"take off shoes\n"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">on_exit_last_one_wins</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; put on socks</span>
<span class="co">#&gt; put on shoes</span>
<span class="co">#&gt; take off shoes</span></code></pre></div>
<p>Oops, we still have our socks on! The last-in, first-out, stack-like behaviour of <code><a href="../reference/defer.html">defer()</a></code> tends to be what you want in most applications.</p>
<p>To get such behaviour with <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>, remember to call it with <code>add = TRUE, after = FALSE</code><a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">on_exit_stack</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"put on socks\n"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"take off socks\n"</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, after <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"put on shoes\n"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"take off shoes\n"</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, after <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">on_exit_stack</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; put on socks</span>
<span class="co">#&gt; put on shoes</span>
<span class="co">#&gt; take off shoes</span>
<span class="co">#&gt; take off socks</span></code></pre></div>
<p>Conversely, if you want <code><a href="../reference/defer.html">defer()</a></code> to have first-in, first-out behaviour, specify <code>priority = "last"</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">defer_queue</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Adam gets in line for ice cream\n"</span><span class="op">)</span>
  <span class="fu"><a href="../reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Adam gets ice cream\n"</span><span class="op">)</span>, priority <span class="op">=</span> <span class="st">"last"</span><span class="op">)</span>

  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Beth gets in line for ice cream\n"</span><span class="op">)</span>
  <span class="fu"><a href="../reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Beth gets ice cream\n"</span><span class="op">)</span>, priority <span class="op">=</span> <span class="st">"last"</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">defer_queue</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Adam gets in line for ice cream</span>
<span class="co">#&gt; Beth gets in line for ice cream</span>
<span class="co">#&gt; Adam gets ice cream</span>
<span class="co">#&gt; Beth gets ice cream</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="local-functions-and-with-functions">“Local” functions (and “with” functions)<a class="anchor" aria-label="anchor" href="#local-functions-and-with-functions"></a>
</h2>
<p>Both <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> and <code><a href="../reference/defer.html">withr::defer()</a></code> schedule actions to be executed when a certain environment goes out of scope, most typically the execution environment of a function. But the <code>envir</code> argument of <code><a href="../reference/defer.html">withr::defer()</a></code> lets you specify a <em>different</em> environment, which makes it possible to create customised <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> extensions.</p>
<p>Let’s look at the <code>neater()</code> function again.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neater</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span> <span class="co"># record orig. "digits" &amp; change "digits"</span>
  <span class="fu"><a href="../reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span><span class="op">)</span>                 <span class="co"># schedule restoration of "digits"</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The first two lines are typical <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> maneuvers where, in some order, you record an original state, arrange for its eventual restoration, and change it. In real life, this can be much more involved and you might want to wrap this logic up into a helper function. You can’t wrap <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> in this way, because there’s no way to reach back up into the correct parent frame and schedule cleanup there. But with <code><a href="../reference/defer.html">defer()</a></code>, we can! Here is such a custom helper, called <code>local_digits()</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">local_digits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sig_digits</span>, <span class="va">envir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span>
  <span class="fu"><a href="../reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>, envir <span class="op">=</span> <span class="va">envir</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We can use <code>local_digits()</code> to keep any manipulation of <code>digits</code> local to a function.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neato</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">local_digits</span><span class="op">(</span><span class="va">digits</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span>

<span class="fu">neato</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.1</span>

<span class="fu">neato</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">4</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.142</span></code></pre></div>
<p>You can even call <code>local_digits()</code> multiple times inside a function. Each call to <code>local_digits()</code> is in effect until the next or until the function exits, which ever comes first.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neatful</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">local_digits</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="fu">local_digits</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="fu">local_digits</span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">neatful</span><span class="op">(</span><span class="va">pi</span><span class="op">)</span>
<span class="co">#&gt; [1] 3</span>
<span class="co">#&gt; [1] 3.14</span>
<span class="co">#&gt; [1] 3.1416</span></code></pre></div>
<p>Certain state changes, such as modifying global options, come up so often that withr offers pre-made helpers. These helpers come in two forms: <code>local_*()</code> functions, like the one we just made, and <code>with_*()</code> functions, which we explain below. Here are the state change helpers in withr that you are most likely to find useful:</p>
<table class="table">
<thead><tr class="header">
<th>Do / undo this</th>
<th>withr functions</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Set an R option</td>
<td>
<code><a href="../reference/with_options.html">local_options()</a></code>,<code><a href="../reference/with_options.html">with_options()</a></code>
</td>
</tr>
<tr class="even">
<td>Set an environment variable</td>
<td>
<code><a href="../reference/with_envvar.html">local_envvar()</a></code>, <code><a href="../reference/with_envvar.html">with_envvar()</a></code>
</td>
</tr>
<tr class="odd">
<td>Change working directory</td>
<td>
<code><a href="../reference/with_dir.html">local_dir()</a></code>, <code><a href="../reference/with_dir.html">with_dir()</a></code>
</td>
</tr>
<tr class="even">
<td>Set a graphics parameter</td>
<td>
<code><a href="../reference/with_par.html">local_par()</a></code>, <code><a href="../reference/with_par.html">with_par()</a></code>
</td>
</tr>
</tbody>
</table>
<p>We didn’t really need to write our own <code>local_digits()</code> helper, because the built-in <code><a href="../reference/with_options.html">withr::local_options()</a></code> also gets the job done:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neatest</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/with_options.html">local_options</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span>

<span class="fu">neatest</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">2</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.1</span>

<span class="fu">neatest</span><span class="op">(</span><span class="va">pi</span>, <span class="fl">4</span><span class="op">)</span>
<span class="co">#&gt; [1] 3.142</span></code></pre></div>
<p>The <code>local_*()</code> functions target a slightly different use case from the <code>with_*()</code> functions, which are inspired by base R’s <code><a href="https://rdrr.io/r/base/with.html" class="external-link">with()</a></code> function:</p>
<ul>
<li>
<p><code>with_*()</code> functions are best for executing a small snippet of code with a modified state</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neat_with</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># imagine lots of code here</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="../reference/with_options.html">with_options</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="co"># ... and a lot more code here</span>
<span class="op">}</span></code></pre></div>
</li>
<li>
<p><code>local_*()</code> functions are best for modifying state “from now until the function exits”</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">neat_local</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">sig_digits</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="../reference/with_options.html">local_options</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="va">sig_digits</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="co"># imagine lots of code here</span>
<span class="op">}</span></code></pre></div>
</li>
</ul>
<p>It’s best to minimize the footprint of your state modifications. Therefore, use <code>with_*()</code> functions where you can. But when this forces you to put lots of (indented) code inside <code>with_*()</code>, e.g. most of your function’s body, then it’s better to use <code>local_*()</code>.</p>
</div>
<div class="section level2">
<h2 id="deferring-events-on-the-global-environment">Deferring events on the global environment<a class="anchor" aria-label="anchor" href="#deferring-events-on-the-global-environment"></a>
</h2>
<p>Here is one last difference between <code><a href="../reference/defer.html">withr::defer()</a></code> and <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code>: the ability to defer events on the global environment<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>.</p>
<p>At first, it sounds pretty weird to propose scheduling deferred actions on the global environment. It’s not ephemeral, the way function execution environments are. It goes out of scope very rarely, i.e. when you exit R. Why would you want this?</p>
<p>The answer is: for development purposes.</p>
<p>If you are developing functions or tests that use withr, it’s very useful to be able to execute that code interactively, without error, and with the ability to trigger the deferred events. It’s hard to develop with functions that work one way inside a function, but another way in the global environment (or, worse, throw an error).</p>
<p>Here’s how <code><a href="../reference/defer.html">defer()</a></code> (and all functions based on it) works in an interactive session.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://withr.r-lib.org">withr</a></span><span class="op">)</span>

<span class="fu"><a href="../reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"hi"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Setting deferred event(s) on global environment.</span>
<span class="co">#&gt;   * Execute (and clear) with `withr::deferred_run()`.</span>
<span class="co">#&gt;   * Clear (without executing) with `withr::deferred_clear()`.</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span>

<span class="co"># this adds another deferred event, but does not re-message</span>
<span class="fu">local_digits</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.14</span>

<span class="fu"><a href="../reference/defer.html">deferred_run</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; [1] "hi"</span>

<span class="va">pi</span>
<span class="co">#&gt; [1] 3.141593</span></code></pre></div>
<p>When you defer events on the global environment, you get a message that alerts you to the situation. If you add subsequent events, the message is <em>not</em> repeated. Since the global environment isn’t perishable, like a test environment is, you have to call <code><a href="../reference/defer.html">deferred_run()</a></code> explicitly to execute the deferred events. You can also clear them, without running, with <code><a href="../reference/defer.html">deferred_clear()</a></code>.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>It’s too bad <code>add = TRUE</code> isn’t the default, because you almost always want this. Without it, each call to <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> clobbers the effect of previous calls.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Note: the <code>after</code> argument of <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> first appeared in R 3.5.0.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>This feature first appeared in withr v2.2.0.<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="http://jimhester.com" class="external-link">Jim Hester</a>, Lionel Henry, Kirill Müller, Kevin Ushey, <a href="http://hadley.nz" class="external-link">Hadley Wickham</a>, Winston Chang.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
